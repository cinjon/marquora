<style>
body {
  width: 620px;
  overflow-x:hidden;
}

#buttons {
}

#container {
	margin-top: 30px;
}

a.question_text {
	width: 450px;
	margin-right: 10px;
	float: left;
}

button.hideButton {
	margin-right: 10px;
	width: 45px;
	float: left;
	text-align: center;
}

button.bookButton {
	float: left;
	width: 80px;
	text-align: center;
}

img {
  margin:5px;
  border:2px solid black;
  vertical-align:middle;
  width:75px;
  height:75px;
}

p.message {
	text-align:center;
}

</style>

<html>
<head>
  <script>
    var logging = true;
	var display = {};
	var buttonsMade = false;
	
	chrome.tabs.getSelected(null, function(tab) {
		buttonsMade = true;
		makeCloseButton()
		makeClearButton()
		makeGetChoiceButton('getquestions')
		makeGetChoiceButton('getbookmarks')
		makeGetChoiceButton('gethiddens')
		paint(display, tab)
	});
	
	function makeCloseButton() {
		var closeButton = document.getElementById('closeButton')
		closeButton.addEventListener("click", function() {
			self.close();
		});
	}
	
	function makeClearButton() {
		var clearButton = document.getElementById('clearButton')
		clearButton.addEventListener("click", function() {
			self.clearStorage();
		});
	}
	
	function makeGetChoiceButton(getChoice) {
		var choice = getChoice.substring(3)
		var button = document.getElementById(getChoice)
		button.addEventListener("click", function() {
			show(getChoice.substring(3))
		});
	}
	
	function show(divElem) {
		turnElemNone('questions')
		turnElemNone('hiddens')
		turnElemNone('bookmarks')
		document.getElementById(divElem).style.display = "block"
	}
	
	function turnElemNone(choice) {
		var elem = document.getElementById(choice)
		elem.style.display = "none"
	}
	
	function paint(display, tab) {
		chrome.extension.getBackgroundPage().retrieveData(tab, function(data) {
			display["questions"] = data["questions"]
			display["bookmarks"] = data["bookmarks"]
			display["hiddens"]   = data["hiddens"]
			
			paintQuestions(display["questions"], 'questions', tab.id)
			paintQuestions(display["bookmarks"], "bookmarks", tab.id)
			paintQuestions(display["hiddens"], 'hiddens', tab.id)
			show("questions")
		});
	}
	
	function paintQuestions(displaychoice, choice, tabId) {
		if(displaychoice && displaychoice["routs"] && displaychoice["routs"].length > 0) {
			hrefs = displaychoice["hrefs"]
			texts = displaychoice["quest"]
			routs = displaychoice["routs"]
			for(var i = 0; i < routs.length; i++) {
				paintSingleQuestion(makeQuestion(hrefs[i], routs[i], texts[i]), choice, tabId)
			} 
		}
		else {
			paintNullChoice(choice) 
		}
	}
	
	function paintSingleQuestion(question, choice, tabId) {
		var container = document.getElementById(choice)
		deleteNullChoice(choice)
		
		if(question && question["rout"] && container) {
			var href = question["href"]
			var text = question["text"]
			var rout = question["rout"]
			var div = document.createElement('div')
			div.id = choice + "_" + rout;
			var anchor = makeAnchor(href, text);
			var hideButton = makeHideButton(href, rout, text, tabId);
			var bookButton = makeBookButton(href, rout, text, tabId);				
			var storedValues = getValue(rout)
			
			
			div.appendChild(anchor);
			div.appendChild(hideButton);
			div.appendChild(bookButton);
			container.appendChild(div)
		}
		else {
			log("question: " + question + "\tcontainer: " + container + "\tbad in paintSingleQuestion")
		}
	}
	
	function paintNullChoice(choice) {
		log(choice.substring(0,1) + "p is the Id")
		var p = document.getElementById(choice.substring(0,1) + "p")
		log(p.innerHTML + " is in choice: " + choice)
		if(choice == "bookmarks") {
			p.innerHTML = "No Bookmarks"
		}
		else if(choice == "hiddens") {
			p.innerHTML = "Nothing Hidden"
		}
		else if(choice == "questions") {
			p.innerHTML = "No Questions"
		}
		log(p.innerHTML + " is after choice: " + choice)
	}
	
	function deleteNullChoice(choice) {
		var p = document.getElementById(choice.substring(0,1) + "p")
		if(p) {
			if(choice == "bookmarks") {
				p.innerHTML = "Bookmarked Quoras"
			}
			else if(choice == "hiddens") {
				p.innerHTML = "Hidden Quoras"
			}
			else if(choice == "questions") {
				p.innerHTML = "Current Quoras"
			}
		}
	}
	
	function tellAllDisplays(rout, hidebook, text) {
		tellSingleDisplay(rout, text, hidebook, "hiddens")
		tellSingleDisplay(rout, text, hidebook, "questions")
		tellSingleDisplay(rout, text, hidebook, "bookmarks")
	}
	
	function tellSingleDisplay(rout, text, hidebook, choice) {
		log(choice + "_" + rout)
		var buttonElem  = document.getElementById(choice + "_" + rout)
		if(buttonElem) {
			var childElems = buttonElem.childNodes;
			if(hidebook == "hide") {
				childElems[1].innerHTML = text
			}
			else if(hidebook == "book") {
				childElems[2].innerHTML = text
			}	
		}
	}
	
	function peelFromEverywhere(rout) {
		peelSingleQuestion(rout, "hiddens")
		peelSingleQuestion(rout, "bookmarks")
		peelSingleQuestion(rout, "questions")
	}
	
	function peelStorage() {
		resetDiv("bookmarks")
		resetDiv("hiddens")
	}
	
	function resetDiv(choice) {
		var divElem = document.getElementById(choice)
		var display = divElem.style.display
		var parentElem = divElem.parentNode
		parentElem.removeChild(divElem)
		var newChild = document.createElement('div') 
		newChild.style.display = display
		newChild.id = choice
	}
	
	function peelSingleQuestion(rout, choice) {
		var divElem = document.getElementById(choice + '_' + rout)
		var parent = divElem.parentNode
		parent.removeChild(divElem)
		if(parent.childNodes.length == 3) {
			log("no parent for this child " + rout + " and this choice: " + choice)
			paintNullChoice(choice)
		}
	}
	
	function makeAnchor(href, text) {
		var anchor = document.createElement('a')
		anchor.href = href;
		anchor.className = "question_text"
		anchor.innerHTML = text
		anchor.addEventListener("click", function() {
			chrome.tabs.create({url: this.href});
			self.close();
			return(false);
		});
		return anchor;
	}
	
	function getChoiceFromValues(values, choice) {
		if(values && choice) {
			for(var i = 0; i < values.length; i++) {
				if(values[i].substring(0,4) == choice) {
					return values[i]
				}
			}
		}
		return null;
	}
	
	function makeHideButton(href, rout, text, tabId) {
		log("rout,text,tabId:\n" + rout + "\n" + text + ", ***:" + tabId)
		var hideButton = document.createElement('button');
		hideButton.className = 'hideButton';
		var value = getChoiceFromValues(getValue(rout), "hide");
		if(value) {
			hideButton.innerHTML = "Reveal"
		}
		else {
			hideButton.innerHTML = "Hide";
		}
		setAttributes(hideButton, href, rout, text)
		hideButton.addEventListener("click", function() {
			if(this.innerHTML == "Hide") {
				this.innerHTML = "Reveal"
				mark = true
			}
			else {
				this.innerHTML = "Hide"
				mark = false
			}
			hide(tabId, this.getAttribute('href'), this.getAttribute('rout'), this.getAttribute('text'), mark);
			return(false);
		});
		return hideButton;
	}
	
	function makeBookButton(href, rout, text, tabId) {
		var bookButton = document.createElement('button');
		bookButton.className = 'bookButton';
		var value = getChoiceFromValues(getValue(rout), "book");
		if(value) {
			bookButton.innerHTML = "UnBookmark"
		}
		else {
			bookButton.innerHTML = "Bookmark";
		}
		setAttributes(bookButton, href, rout, text)
		bookButton.addEventListener("click", function() {
			if(this.innerHTML == "Bookmark") {
				this.innerHTML = "UnBookmark"
				mark = true;
			}
			else {
				this.innerHTML = "Bookmark"
				mark = false;
			}
			book(tabId, this.getAttribute('href'), this.getAttribute('rout'), this.getAttribute('text'), mark);
			return(false)
		});
		return bookButton;
	}
	
	function setAttributes(button, href, rout, text) {
		button.setAttribute('rout', rout)
		button.setAttribute('href', href)
		button.setAttribute('text', text)
	}
	
	function hide(tabId, href, rout, text, mark) {
		log(tabId + " is tabid")
		chrome.extension.getBackgroundPage().hide(tabId, href, rout, text, mark, function() {
			if(mark) {
				paintSingleQuestion(makeQuestion(href, rout, text), 'hiddens', tabId)
				tellAllDisplays(rout, "hide", "Reveal")
			}
			else {
				peelSingleQuestion(rout, "hiddens")
				tellAllDisplays(rout, "hide", "Hide")
			}
		});
	}
	
	function book(tabId, href, rout, text, mark) {
		chrome.extension.getBackgroundPage().book(href, rout, text, mark, function() {
			if(mark) {
				paintSingleQuestion(makeQuestion(href, rout, text), 'bookmarks', tabId)
				tellAllDisplays(rout, "book", "UnBookmark")
			}
			else {
				peelSingleQuestion(rout, "bookmarks")
				tellAllDisplays(rout, "book", "Bookmark")
			}
		});
	}
	
	function makeQuestion(href, rout, text) {
		var question = {}
		question["href"] = href
		question["rout"] = rout
		question["text"] = text
		return question
	}
	
	function getValue(key) {
		return chrome.extension.getBackgroundPage().getItem(key);
	}
	
	function log(txt) {
		if(logging) {
			chrome.extension.getBackgroundPage().log(txt);
		}
	}
	
	function clearStorage() {
		try {
	        chrome.extension.getBackgroundPage().clearStorage();
			peelStorage()
	    } catch(e) {
	        log("error while clearing local storage");
	        log(e);
	     }
    }
  </script>

</head>
<body>
	<div id="buttons">
	  <button id="clearButton" style="float:right">Clear Storage</button>
	  <button id="closeButton" style="float:right">Close</button>
	  <button id="getquestions" style="float:left">Current Quoras</button>
	  <button id="getbookmarks" style="float:left">BookMarked Quoras</button>
	  <button id="gethiddens" style="float:left">Hidden Quoras</button> 
	</div>
	<div id="container">
	    <div id="bookmarks">
		  <p id="bp" class="message">Bookmarked Quoras</p>
	    </div>
		<div id="hiddens">
		  <p id="hp" class="message">Hidden Quoras</p>
		</div>
	    <div id="questions">
		  <p id="qp" class="message">Current Quoras</p>
	    </div>
	</div>
<hr />
</body>
</html>